function _createForOfIteratorHelperLoose(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function asyncGeneratorStep(e,t,r,n,a,i,o){try{var c=e[i](o),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,a)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var i=e.apply(t,r);function o(e){asyncGeneratorStep(i,n,a,o,c,"next",e)}function c(e){asyncGeneratorStep(i,n,a,o,c,"throw",e)}o(void 0)}))}}define(["jquery","i18n","url","api!core.getSysCurrs","api!core.getAppCfg","lodash","request","moment","dateDiff","admin/calendar/getEvents","admin/calendar/setHandlers","@fullcalendar/core","@fullcalendar/timeline","@fullcalendar/resource-common","@fullcalendar/resource-timeline","@fullcalendar/interaction","@fullcalendar/locales/"+(window.momentLangs[window._user.language]||"en-gb"),"fullscreen-api-polyfill","jquery-block"],(function(e,t,r,n,a,i,o,c,s,d,u,l,f,p,m,h){var g=d.getEvents,v=d.getRegions;return function(d){var _=d.filter,b=d.regions,y=void 0===b?[]:b,w=d.MASTER_BUILDING,x=d.MASTER_APARTMENT;return e((function(){"use strict";var d,b=t("Single units"),k=t("Condition"),R=t("Restriction"),E=t("Rate");l.config.mockSchedulerReleaseDate=new Date("2019-01-01");var A=e(window),M=e("#maincontent"),S=new Set,T={w:A.width(),h:A.height()},C=M.find(".calendar");C.block();var D="YYYY-MM-DD",O=[f,p,m,h].map((function(e){return e.default})),G=s(c.utc(_.from,D),c.utc(_.to,D))+1;var I=function(){for(var e=c.utc(_.from,D).startOf("day").hours(12),t=c.utc(_.to,D).startOf("day").hours(12),r=[];e.isSameOrBefore(t);)r.push(e.clone().startOf("day").hours(12)),e.add(1,"day");return r}(),P=["sun","mon","tue","wed","thu","fri","sat"].map((function(e,t){return".fc-timeline .fc-head tbody tr:last-child .fc-"+e+'::before { content: "'+c.utc().day(t).format("ddd").toUpperCase()+'";}'})).join("\n");C.append("<style>"+P+"</style>");var q,j=M.find('[name="type[]"]').val()||["contract","booked","reserved","canceled","maintenance","blocked","canceled"],L={},F={},N={},B={},z=i.debounce((function(){window.requestAnimationFrame((function(){q.batchRendering((function(){i(C.find(".fc-time-area tr[data-resource-id]:visible")).map((function(e){return e.dataset.resourceId})).uniq().forEach((function(e){var t=q.getResourceById(e);t&&(B[e]?(i.each(B[e],(function(e){q.addEvent(e)})),B[e]=[]):e.includes("_rate")&&t.extendedProps.apartment&&function(e){if(!F[e._id])return;var t={},r={};i.each(F[e._id],(function(n){var o=n.prices,s=n._dt,d=c.utc(new Date(s)).format(D);i.each(o,(function(n){var i=n.days,o=n.price,c=n._t_promo,u=void 0===c?0:c,l=n._t_custom,f=void 0===l?0:l;"basic"===a.priceModel.model&&(f=0);var p=e._id+"_rate"+i;t[i]=t[i]||[],u&&!r[i]?r[i]="rgba(255, 255, 204, 1)":u||(r[i]="rgba(107, 185, 240, 1)"),t[i].push({id:e._id+"_rate"+i+"_"+d+"_"+u+"_"+f,resourceId:p,allDay:!0,start:s,end:s,classNames:"text-center event-rate-bg",backgroundColor:_.channel?"transparent":u?"rgba(255, 255, 204, 1)":f?"rgba(68, 108, 179, 0.7)":"rgba(107, 185, 240, 1)",title:o[e._t_curr]?o[e._t_curr].toString():"",rendering:"background",apartment:e})}))})),_.channel||i.each(t,(function(t,n){var a=new Set(t.map((function(e){return c.utc(new Date(e.start)).format(D)})));i.each(I,(function(i){var o=i.format(D);a.has(o)||t.push({id:e._id+"_rate"+n+"_"+o+"_0_0",resourceId:e._id+"_rate"+n,allDay:!0,start:i.toDate(),end:i.toDate(),backgroundColor:r[n]||"rgba(107, 185, 240, 1)",rendering:"background",apartment:e})}))}));if("basic"===a.priceModel.model){var n=i.map(a.priceModel.periods,"_i_value");i.each(n,(function(r){if(!t[r]){var n=c.utc(_.from,D).format(D);t[r]=[{id:e._id+"_rate"+r+"_"+n+"_0_0",resourceId:e._id+"_rate"+r,allDay:!0,start:c.utc(_.from,D).toDate(),end:c.utc(_.to,D).add(1,"day").toDate(),backgroundColor:"rgba(107, 185, 240, 1)",rendering:"background",apartment:e}]}}))}i.each(t,(function(e){i.each(e,(function(e){q.getEventById(e.id)||q.addEvent(e)}))}))}(t.extendedProps.apartment))}))}))}))}),10);function H(e,t){e.extprices&&(F[e._id]=e.extprices,delete e.extprices),N[e._id]||(N[e._id]=e);var r,o={id:e._id,building:t._t_building?t._t_building.avatar||t._t_building.id:b,title:[e.avatar,e.cloneGroup?"("+e.cloneGroup.name+")":null,e.priceGroup?"("+e.priceGroup.name+")":null].filter(Boolean).join(" "),children:[],r_type:{booking:!0,price:!0,blocking:!0},apartment:e};if(e._idPriceGroup||e._idcloneof)o.hasMaster=e._idcloneof||e._idPriceGroup;else{var c={id:e._id+"_promo",title:(r=k,(_.channel?M.find('[name="channel"] [value="'+_.channel+'"]').text():r)+" (%)"),r_type:"promotion",children:[],apartment:e};if(o.children.unshift(c),c.children.push({id:e._id+"_rest",title:R,r_type:"restriction",apartment:e}),F[e._id]){var s="basic"===a.priceModel.model?i.map(a.priceModel.periods,"_i_value"):[],d=i(F[e._id]).map("prices").flatten().map("days").uniq().value();i.each(s,(function(e){d.includes(e)||d.push(e)})),d.sort((function(e,t){return e-t})),i.each(d,(function(t){c.children.push({id:e._id+"_rate"+t,title:E+" "+t.toString().padStart(2,"0")+" ("+i.get(n,e._t_curr+".char",e._t_curr)+")",r_type:"rate",apartment:e})}))}}return o}function U(e){return Y.apply(this,arguments)}function Y(){return(Y=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var n,c,s,d,u,l,f,p;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.start,c=t.end,s=r.parse(window.location),w&&(s.query["buildings[]"]=w._id,s.query._idregion="all",s.query["active[]"]=["yes","hidden","draft"]),x&&(s.query["_idapartment[]"]=x._id,s.query._idregion="all",s.query["active[]"]=["yes","hidden","draft","no"]),s.pathname=window._prefix+"calendars",e.next=7,o(r.format(s,1),{body:{start:n,end:c}});case 7:return d=e.sent,u=[],"all"!==s.query._idregion&&y.forEach((function(e){a.promotionModel._b_simple&&u.push({id:e._id+"_promo",building:e._s_name,title:k+" (%)",r_type:"promotion",apartment:{_idregion:e._id},eventAllow:function(){return!1}}),u.push({id:e._id+"_rest",building:e._s_name,title:R,r_type:"restriction",apartment:{_idregion:e._id},eventAllow:function(){return!1}})})),l=function(){var e=p.value;i.each(e.apartments,(function(t){u.push(H(t,e)),i.each(t._t_children,(function(t){u.push(H(t,e))}))}))},e.t0=_createForOfIteratorHelperLoose,e.next=14,d;case 14:e.t1=e.sent,f=(0,e.t0)(e.t1);case 16:if((p=f()).done){e.next=20;break}l();case 18:e.next=16;break;case 20:return e.abrupt("return",u);case 21:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function $(e){return W.apply(this,arguments)}function W(){return(W=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var r,n,a,o,s,d,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.start,n=t.end,B={},r=c.utc(r).startOf("day").hours(12).format(D),n=c.utc(n).startOf("day").hours(12).format(D),q.batchRendering((function(){q.getEvents().forEach((function(e){e.remove()}))})),"all"===_._idregion){e.next=10;break}return e.next=8,v({regions:y,multicalendar:!0,start:r,end:n,filter:Object.assign({},_,{types:j})});case 8:a=e.sent,Object.assign(B,i.groupBy(a,"resourceId"));case 10:o=_createForOfIteratorHelperLoose(i.chunk(Object.values(N),20));case 11:if((s=o()).done){e.next=19;break}return d=s.value,e.next=15,g({apartments:d,multicalendar:!0,start:r,end:n,allowDraggable:!0,rejectCanceled:!j.includes("canceled"),filter:Object.assign({},_,{types:j})});case 15:u=e.sent,Object.assign(B,i.groupBy(u,"resourceId"));case 17:e.next=11;break;case 19:z();case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var K=e('<div class="btn btn-default"><i class="fa fa-arrows visible-xs-inline" aria-hidden="true"></i><span class="hidden-xs">'+t("fullscreen")+"</span></div>"),V=e('<div class="btn btn-default visible-xs"><i class="fa fa-picture-o" aria-hidden="true"></i></div>'),Z=e('<div class="btn-group"/>');if(Z.append(V),document.fullscreenEnabled){var J=C.closest(".multicalendar-container")[0];Z.append(K),K.on("click",(function(){window.toggleFullscreen(J)}))}function Q(){q.batchRendering((function(){T.w<992?(q.setOption("height",T.h-25),C.closest(".well").css("padding-bottom","")):(q.setOption("height",x?"auto":T.h-C.offset().top-25),x||document.fullscreenElement||C.closest(".well").css("padding-bottom","0px"))}))}V.on("click",(function(){i.each(N,(function(e){e._t_imgavatar&&e._t_imgavatar.toggleClass("hidden-xs")})),e(this).toggleClass("active")})),q=new l.Calendar(C[0],{schedulerLicenseKey:"0092913133-fcs-1555953222",timeZone:"UTC",allDayDefault:!0,slotWidth:32,locale:window.momentLangs[window._user.language]||"en-gb",firstDay:1,eventLimit:!0,startEditable:!1,durationEditable:!1,refetchResourcesOnNavigate:!1,resourcesInitiallyExpanded:!!x,height:x?"auto":null,resourceGroupField:"building",resourceLabelText:t("Listing"),selectable:!0,displayEventTime:!1,plugins:O,slotLabelFormat:[{month:"long",year:"numeric"},{day:"2-digit"}],defaultDate:_.from,eventOrder:["order","start","title"],resourceAreaWidth:T.w>992?"170px":"100px",defaultView:"resourceTimelineMonth",resources:function(e){return _asyncToGenerator(regeneratorRuntime.mark((function t(){var r,n,a,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.start,n=e.end,r&&n){t.next=3;break}return t.abrupt("return",[]);case 3:if(a=[r,n].join(),!L[a]){t.next=6;break}return t.abrupt("return",L[a]);case 6:return L[a]=_asyncToGenerator(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,U({start:r,end:n});case 2:return t=e.sent,e.next=5,$({start:r,end:n});case 5:return e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})))(),t.prev=7,C.block(),t.next=11,L[a];case 11:return i=t.sent,t.abrupt("return",i);case 15:t.prev=15,t.t0=t.catch(7),window.appError(t.t0);case 18:return t.prev=18,delete L[a],window.requestAnimationFrame((function(){C.unblock(),C.find(".fc-divider .fc-expander .fc-icon-plus-square").click()})),t.finish(18);case 22:case"end":return t.stop()}}),t,null,[[7,15,18,22]])})))()},eventRender:function(t){var r=t.event,n=t.el;t.isMirror,t.isStart,t.isEnd,t.view;if("background"===r.rendering)n.title=r.extendedProps.extitle||r.extendedProps.description||r.title,r.classNames.includes("event-rate-bg")||r.classNames.includes("event-spromo-bg")?e(n).append("<b>"+(r.extendedProps.description||r.title)+"</b>"):r.classNames.includes("event-last-minute-bg")?e(n).append('<b style="color: rgba(207, 0, 15, 1)">'+(r.extendedProps.description||r.title)+"</b>"):r.classNames.includes("event-restriction-bg")&&e(n).append('<b style="color: rgba(207, 0, 15, 1)">'+(r.extendedProps.description||r.title).split(" ").join("<br>")+"</b>");else if(n.title=r.title,r.extendedProps.hasGroup){var a=e(n);a.attr("data-hasGroup",r.extendedProps.hasGroup),a.find(".fc-title").html('<i class="fa fa-link" aria-hidden="true"></i> '+r.title)}},eventPositioned:function(t){var r=t.event,n=t.el,a=(t.isMirror,t.isStart),i=t.isEnd,o=t.view;if("background"!==r.rendering){var c=!1,s={};a&&(c=!0,s["margin-left"]=d+1+"px"),i&&r.end<o.activeEnd&&(c=!0,s["margin-right"]="-"+(d-1)+"px"),c&&e(n).css(s)}},eventOverlap:function(e,t){return!e.extendedProps.reserve_type||"canceled"===e.extendedProps.reserve_type},header:{left:"",center:"",right:""},views:{resourceTimelineMonth:{eventLimit:1,type:"resourceTimeline",duration:{days:Math.min(Math.max(18,G),366)}}},viewSkeletonRender:function(){setTimeout((function(){d=C.find(".fc-widget-header[data-date]").not("[colspan]").width()/2,C.find(".fc-button-group").addClass("btn-group").removeClass("fc-button-group"),C.find(".fc-button.fc-button-primary").addClass("btn btn-info").removeClass("fc-button fc-button-primary"),C.find(".fc-button-active").addClass("active").removeClass("fc-button-active"),C.find(".fc-head .fc-widget-header:first .fc-cell-content").replaceWith(Z)}))},resourceRender:function(t){var r=t.resource,n=t.el,a=(t.view,e(n));if(N[r.id])a.find(".fc-icon:first").before(function(t){var r=t.resource,n=t.$el;if(!N[r.id]._t_imgavatar){var a=Math.round(n.height()),i=Math.round(a/2*3),o=new window.Image;o.style="margin: -6px 0px -6px -4px; height: "+a+"px",o.loading="lazy",o.width=i,o.height=a,o.src=N[r.id]._idavatar?"/image/"+N[r.id]._idavatar+"?width="+i+"&height="+a:"/common/img/product_nophoto.png",N[r.id]._idavatar&&(o.onerror=function(){this.src="/common/img/product_nophoto.png"}),N[r.id]._t_imgavatar=e('<a target="_blank" class="hidden-xs" href="'+window._prefix+"apartment/"+N[r.id].id+'/calendar"></a>'),N[r.id]._t_imgavatar.append(o)}return N[r.id]._t_imgavatar}({resource:r,$el:a}));else{var i=Math.round(a.height()),o=T.w>992?Math.round(1.5*i):0;a.find(".fc-icon:first").before('<div class="visible-sm-inline-block visible-md-inline-block visible-lg-inline-block" style="width: '+o+'px;"></div>')}},events:function(e){return _asyncToGenerator(regeneratorRuntime.mark((function t(){var r,n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.start,n=e.end,r&&n){t.next=3;break}return t.abrupt("return",[]);case 3:return q&&q.refetchResources(),t.abrupt("return",[]);case 5:case"end":return t.stop()}}),t)})))()},selectAllow:_.channel?function(e){return!e.resource.extendedProps.apartment||!e.resource.id.includes("_rate")&&(!e.resource.id.includes("_rest")&&("website"===_.channel||!e.resource.id.includes("_promo")))}:null}),u({$calendar:C,fullcalendar:q}),q.rerenderDelay=100,q.render(),A.on("resize.maincontent fullscreenchange.maincontent",(function(e){window.requestAnimationFrame((function(){var t=A.width(),r=A.height();"resize"===e.type&&T.w===t&&T.h===r||("fullscreenchange"===e.type&&K.toggleClass("active",!!document.fullscreenElement),T.w=t,T.h=r,Q())}))})),Q(),C.on("mouseup touchend",".fc-col-resizer",Q),C.on("click",".fc-expander",z),C.on("click","[data-date]:not([colspan]).fc-widget-header",(function(){var e=this.dataset.date;return S.has(e)?(C.find("[data-date="+e+"]:not([colspan])").removeClass("fc-custom-highlight"),S.delete(e)):(C.find("[data-date="+e+"]:not([colspan])").addClass("fc-custom-highlight"),S.add(e)),!1}))}))}}));