function asyncGeneratorStep(e,n,t,r,a,i,o){try{var c=e[i](o),s=c.value}catch(e){return void t(e)}c.done?n(s):Promise.resolve(s).then(r,a)}function _asyncToGenerator(e){return function(){var n=this,t=arguments;return new Promise((function(r,a){var i=e.apply(n,t);function o(e){asyncGeneratorStep(i,r,a,o,c,"next",e)}function c(e){asyncGeneratorStep(i,r,a,o,c,"throw",e)}o(void 0)}))}}define(["jquery","safe","api","clitpl","checkperm","lodash","views/reservation/editPayment","jquery-block"],(function(e,n,t,r,a,i,o){return function(o){var c=o.$modal_,s=o._idform,d=o.client,m=o._idreserve,l=o.type,u=o.id,p=o.onlyCCPayment,f=o.apartment;return e((function(){var o=e("#"+s);function v(e){var n=e.find(".payment-confirm-animation");e.unblock(),e.find(".payment-confirm, .payment-confirm-animation").toggleClass("hidden"),e.find("#process-animation .circle").addClass("processing"),setTimeout((function(){e.find("#process-animation .right").addClass("processing")}),1e3),setTimeout((function(){n.find("#pay-process").addClass("hidden"),n.find("#pay-saved").removeClass("hidden"),e.find(".payment-header").addClass("confirm"),e.find("#process-animation .right").addClass("saved")}),1500),setTimeout((function(){e.trigger("frm-closed")}),2500)}a(["reserve.payment.add"])&&o.on("click",".btn-add-payment, .btn-add-deposit",_asyncToGenerator(regeneratorRuntime.mark((function a(){var s,_,y,g,b,h,k,w;return regeneratorRuntime.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return"new"===(s=e(this)).data("_id")&&(_=1,s.closest(".deposit-container").length&&(y=1)),a.next=4,t.call("core._getUser",{});case 4:return g=a.sent,a.next=7,t.call("bank.getAccountsEx",{query:{_b_active:1,_s_channel:"user",_iduser:g._id}});case 7:return b=a.sent,h={apartment:{_idresuser:f._idresuser,id:f.id,avatar:f.avatar},reserve:{_id:m,id:u,type:l},contact:{_id:d._id,name:d.name,lang:i.toArray(d._t_languages)[0]||window.__defaultLang,clientEmail:i.get(d,"emails.0.adr"),cc:d.cc},onlyCCPayment:p,cashAvailable:!i.isEmpty(b),userFinanceGateway:b,is_new:_,_b_deposit:y},a.prev=9,a.next=12,t.call("bank.getAccountsEx",{query:{_b_active:1,_s_channel:"simplebank",_b_virtual:{$ne:1},_b_untracked:{$ne:1}},fields:{name:1}});case 12:return h.banks=a.sent,a.next=15,r._render("reservation/booking_payment_add_dialog",h);case 15:k=a.sent,(w=e(k).modal()).on("click",".btn-back-first",(function(){return w.block(),w.trigger("frm-first-step"),!1})),w.on("click",".btn-back-second",(function(){return w.block(),w.trigger("frm-change-step"),!1})),w.on("hidden.bs.modal",(function(){w.remove()})),w.on("frm-confirm-payment",function(){var n=_asyncToGenerator(regeneratorRuntime.mark((function n(r,a){var o;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,"cash"!=a.source||i.isEmpty(b)||(a._idbank=b[0]._id),y&&(a._b_deposit=y),o=i.cloneDeep(a),i.unset(o,"_b_pending"),n.next=7,t.call("finance.savePayment",{is_new:y?_:1,payment:o,payment1:a,_idreserve:m});case 7:v(w),n.next=13;break;case 10:n.prev=10,n.t0=n.catch(0),window.appError(n.t0);case 13:return n.prev=13,w.unblock(),n.finish(13);case 16:c&&(c.remove(),e(".modal-backdrop").remove(),c=null);case 17:case"end":return n.stop()}}),n,null,[[0,10,13,16]])})));return function(e,t){return n.apply(this,arguments)}}()),w.on("frm-closed",(function(){w.modal("hide"),c&&(c.remove(),e(".modal-backdrop").remove(),c=null),window.pageReload()})),w.on("frm-confirm-payment-cc",(function(){v(w),setTimeout((function(){if("reserved"!==l)return c&&(c.remove(),e(".modal-backdrop").remove(),c=null),window.pageReload();n.run((function(r){t.call("reserve.changeTypeReservation",m,"booked",n.sure_result(r,(function(){c&&(c.remove(),e(".modal-backdrop").remove(),c=null),window.pageReload()})))}),window.appError)}),1500)})),w.on("frm-cancel",(function(){w.modal("hide")})),w.on("frm-confirm-animation",(function(){v(w)})),w.on("frm-change-step",(function(){setTimeout((function(){w.find(".payment-edit, .payment-confirm").toggleClass("hidden"),w.find(".payment-header").find("#processing-step").toggleClass("btn-back-second"),w.find(".payment-header").find("#processing-step h4, #confirmation-step h4").toggleClass("active-payment-step"),w.unblock()}),800)})),w.on("frm-first-step",(function(){w.modal("hide"),y?o.find(".btn-add-deposit").click():o.find(".btn-add-payment").click()})),a.next=32;break;case 29:a.prev=29,a.t0=a.catch(9),window.appError(a.t0);case 32:case"end":return a.stop()}}),a,this,[[9,29]])}))))}))}}));