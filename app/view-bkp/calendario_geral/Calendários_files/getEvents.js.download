function _createForOfIteratorHelperLoose(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function asyncGeneratorStep(e,t,r,n,a,o,i){try{var c=e[o](i),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,a)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){asyncGeneratorStep(o,n,a,i,c,"next",e)}function c(e){asyncGeneratorStep(o,n,a,i,c,"throw",e)}i(void 0)}))}}define(["ApiError","i18n","moment","lodash","api","pickTranslate","api!core.getAppCfg"],(function(e,t,r,n,a,o,i){var c,s={late_checkout:t("Late check-Out <& calendar popover &>"),early_checkin:t("Early check-In <& calendar popover &>"),unactive:t("Unactive apartment <& calendar popover &>"),infuture:t("Limit Reservation in Advance <& calendar popover &>"),timegap:t("Timegap inbetween bookings <& calendar popover &>"),contract_ended:t("Contract ended block <& calendar popover &>"),last_minute:t("Last minute block <& calendar popover &>"),Arrival:t("IN <& calendar popover &>"),Departure:t("OUT <& calendar popover &>")},d=t("Promotion"),u=t("Weekend Rate"),l=t("Time Gap!"),p=t("Time Overlap!"),_={contract:t("contract"),booked:t("booked"),reserved:t("reserved"),blocked:t("blocked"),maintenance:t("maintenance"),canceled:t("canceled")},m="YYYY-MM-DD",f=new Set(["contract","booked","reserved","canceled"]);function v(e){var t=e.promotion,n=e.apartment,a=e.multicalendar,o=Object.keys(t._mctotal)[0];return{id:t._id,resourceId:a?n._id+"_promo":n._id,order:2,allDay:!0,start:t._dtfrom,end:t._dtto,resourceEditable:!1,backgroundColor:i.promotionColor,textColor:"black",classNames:("event-promotion btn-pointer "+(window._autotest?"dtstart-"+r.utc(t._dtfrom).format(m)+" dtend-"+r.utc(t._dtto).format(m):"")).trim(),title:t._mctotal[o]?t._mctotal[o].pokLocaleString(window._user.language,{style:"currency",currency:o}):d,apartment:n}}function b(e){var t=e.reserve,n=e.apartment,a=e.multicalendar,o={id:t._id,groupId:t._idparent||t._id,resourceId:n._id,order:1,allDay:!0,title:_[t.type],classNames:"btn-pointer",start:t._dtcheckIn,end:t._dtcheckOut,_t_isFake:t._t_isFake,resourceEditable:!!t._idmasterRes,reserve_type:t.type,apartment:n,reserve:t};return"blocked"===t.type?o.backgroundColor=i.blockingColor:"maintenance"===t.type&&(o.backgroundColor=i.maintenanceColor),t._t_isFake&&(t._t_early?o.classNames="early_checkin":t._t_late?o.classNames="late_checkout":t._t_unactive?o.classNames="unactive":t._t_infuture?o.classNames="infuture":t._t_gap?o.classNames="timegap":t._t_contractEnded?o.classNames="contract_ended":t._t_lastMinuteBlock&&(o.rendering="background",o.backgroundColor=i.blockingColor,o.classNames=a?"text-center event-last-minute-bg text-overflow":"event-last-minute-bg",o.title=s.last_minute),o.title=s[o.classNames]||o.title,o.id=t._idparent,t._t_gap&&(o.classNames+=" btn-pointer")),o.title=o.title||_[t.type],t.id&&(o.title=t.id+" - "+o.title),o.classNames=("event-"+t.type+" "+o.classNames+" "+(window._autotest?"dtstart-"+r.utc(t._dtcheckIn).format(m)+" dtend-"+r.utc(t._dtcheckOut).format(m):"")).trim(),o}function g(e,t){return y.apply(this,arguments)}function y(){return(y=_asyncToGenerator(regeneratorRuntime.mark((function t(r,n){var a,o,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,window.fetch(r,{method:"post",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},cache:"no-cache",body:JSON.stringify(n)});case 2:if(!(a=t.sent).ok){t.next=5;break}return t.abrupt("return",a.json());case 5:return o=a.statusText,t.prev=6,t.next=9,a.text();case 9:o=t.sent,t.next=14;break;case 12:t.prev=12,t.t0=t.catch(6);case 14:throw(i=new e(o)).statusCode=a.status,i;case 17:case"end":return t.stop()}}),t,null,[[6,12]])})))).apply(this,arguments)}function k(){return(k=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var r,a,o,i,c,s,d;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.regions,a=t.multicalendar,o=void 0!==a&&a,i=t.start,c=t.end,s=t.filter,e.next=3,g(window._prefix+"calendar-regions",{idregions:n(r).map("_id").compact().value(),start:i,end:c});case 3:return d=e.sent,e.abrupt("return",x(d,{multicalendar:o,filter:s,start:i,end:c,regions:r}));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function h(){return(h=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var r,a,o,i,c,s,d,u,l;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.apartments,a=t.multicalendar,o=void 0!==a&&a,i=t.start,c=t.end,s=t.rejectCanceled,d=void 0!==s&&s,u=t.filter,e.next=3,g(window._prefix+"calendar-events",{idapartments:n(r).map("_id").compact().value(),types:u.types,_idregion:u._idregion,multicalendar:o,start:i,end:c,rejectCanceled:d,channel:u.channel});case 3:return l=e.sent,e.abrupt("return",x(l,{multicalendar:o,filter:u,start:i,end:c,apartments:r}));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e,t){return w.apply(this,arguments)}function w(){return(w=_asyncToGenerator(regeneratorRuntime.mark((function e(t,g){var y,k,h,x,w,C,I,T,N,R,A,O;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(O=function(e,t){var a=e._id||e._idregion,o=a+"_rest",i=y?"text-center event-restriction-bg":"event-restriction-bg";y&&N.push({id:a+"_bg_rest",resourceId:o,allDay:!0,start:r.utc(k.from,m).toDate(),end:r.utc(k.to,m).add(1,"day").toDate(),backgroundColor:"rgba(123, 239, 178, 0.5)",rendering:"background",apartment:e}),n.each(t,(function(t){var n=Object.keys(t.restriction).filter((function(e){return t.restriction[e]}));if(n.length){var c=n.map((function(e){return s[e]})).join(" "),d=r.utc(t._dt).format(m);N.push({id:a+"_bg_rest_"+d,resourceId:o,allDay:!0,start:t._dt,end:t._dt,description:c,classNames:i,backgroundColor:"transparent",rendering:"background",apartment:e})}}))},A=function(e,t,a,o){var i=e._id||e._idregion,s=i+"_promo";if(n.each(t,(function(t){N.push(v({promotion:t,apartment:e,multicalendar:y}))})),!y||k.channel&&"website"!==k.channel||N.push({id:s,resourceId:s,allDay:!0,start:h,end:x,backgroundColor:"rgba(255, 255, 204, 1)",rendering:"background",apartment:e}),a){var l=y?"text-center event-spromo-bg":"event-spromo-bg",p=d,_=u;n.each(a,(function(t){if(t._f_value){var n=r.utc(t._dt).format(m);N.push({id:i+"_bg_spromo_"+n,resourceId:s,allDay:!0,start:t._dt,end:t._dt,extitle:(t._b_rise?_+" +":p+" -")+t._f_value+"%",description:(t._b_rise?"":"-")+" "+t._f_value+"%",classNames:l,backgroundColor:"transparent",rendering:"background",apartment:e})}}))}if(o){var f=y?"text-center event-spromo-bg":"event-spromo-bg";n.each(o,(function(t){t._f_value&&N.push({id:i+"_bg_sdpr_"+t.dt,resourceId:s,allDay:!0,start:t.dt,end:t.dt,extitle:c[t._idname]+" "+(t._b_rise?"+":"-")+t._f_value+"%",description:(t._b_rise?"":"-")+" "+t._f_value+"%",classNames:f,backgroundColor:"rgba(123, 239, 178, 1)",rendering:"background",apartment:e})}))}},R=function(e,t){var r=0;n.each(t,(function(t){t._i_level?t.color=i.eventColor:(r++,t.color=r%2==0?i.seasonColor1:i.seasonColor2);var n={resourceId:e._id,start:t._dtfrom,end:t._dtto,description:t.name,backgroundColor:t.color,rendering:"background"};if(N.push(n),t._t_error){var a={resourceId:e._id,allDay:!0,start:t._t_error._dtfrom,end:t._t_error._dtto,rendering:"background",backgroundColor:t._t_error.color};t._t_error.isGap?a.title=l:t._t_error.isOverlap&&(a.title=p),N.push(a)}}))},y=g.multicalendar,k=g.filter,h=g.start,x=g.end,w=g.apartments,C=void 0===w?[]:w,I=g.regions,T=void 0===I?{}:I,c){e.next=9;break}return e.next=7,a.cache("translate.getTranslations","priceRules");case 7:c=e.sent,n.reduce(c,(function(e,t){return e[t._id]=o(t._msvalues),e}),c);case 9:return N=[],n.each(T,(function(e){if(t[e._id]){var r=t[e._id],n=r.promo_simple,a=r.restrictions,o=r.priceRules;A(e,[],n,o),O(e,a)}})),e.next=13,Promise.all(C.map(function(){var e=_asyncToGenerator(regeneratorRuntime.mark((function e(n){var o,c,s,d,u,l,p,v,g,k,w,C,I,T;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t[n._id]){e.next=2;break}return e.abrupt("return");case 2:return o=t[n._id],c=o.promo,s=o.promo_simple,d=o.calendar,u=o.restrictions,l=o.priceRules,e.next=5,a.cache("apartment.getPrices",{_id:n._idMasterApartment||n._id,start:h,end:x,checkErrors:1,calendar:1});case 5:p=e.sent,R(n,p),A(n,c,s,l),O(n,u),v=_createForOfIteratorHelperLoose(d);case 10:if((g=v()).done){e.next=31;break}if((k=g.value)._idowner===n._id){e.next=14;break}return e.abrupt("continue",29);case 14:if(!f.has(k.type)){e.next=28;break}if(!k._idclient){e.next=22;break}return e.next=18,a.cache("contact.getContactsEx",{query:{_id:k._idclient},fields:{_id:1,name:1}});case 18:w=e.sent,C=w.list,I=C[0],k._t_client=I;case 22:T={id:k._id,groupId:k._idparent||k._id,resourceId:n._id,order:0,allDay:!0,title:k.id+" - "+(k._t_client?k._t_client.name:"")+" ("+_[k.type]+")",classNames:("event-"+k.type+" btn-pointer "+(window._autotest?"dtstart-"+r.utc(k._dtcheckIn).format(m)+" dtend-"+r.utc(k._dtcheckOut).format(m):"")).trim(),resourceEditable:y&&("reserved"===k.type||"booked"===k.type),startEditable:!1,durationEditable:!1,start:k._dtcheckIn,end:k._dtcheckOut,reserve_type:k.type,apartment:n},"reserved"===k.type?(T.backgroundColor=i.reservedColor,T.textColor="black"):"canceled"===k.type?(T.backgroundColor="#aaa",T.order=3):T.backgroundColor=i.reservationColor,k._idmasterRes&&(T.hasGroup=k._idmasterRes),N.push(T),e.next=29;break;case 28:N.push(b({reserve:k,apartment:n,multicalendar:y}));case 29:e.next=10;break;case 31:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 13:return e.abrupt("return",N);case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}return{getEvents:function(e){return h.apply(this,arguments)},getRegions:function(e){return k.apply(this,arguments)}}}));