function _createForOfIteratorHelperLoose(e,r){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length){n&&(e=n);var t=0;return function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,t=new Array(r);n<r;n++)t[n]=e[n];return t}define(["jquery","i18n","safe","lodash","moment","bootstrap-dialog","api","url","clitpl","amount_ex","datePickers","ApiError","decimal","checkperm","jquery-addons","jquery-block"],(function(e,r,n,t,o,a,c,i,d,u,l,s,_,f){return function(){return e((function(){var i,m=e("#contract").length?e("#contract"):e("#maincontent"),p={},v=0;function b(e,n){return a.confirm({title:r("Warning!"),type:a.TYPE_WARNING,message:r("Are you sure you want to delete this account?"),callback:function(e){if(e)m.block(),c.call("ledger.removeCreditLandlord",n._id,(function(e){m.unblock(),n.paramsModal?m.trigger("partForward",n.paramsModal):window.pageReload(e)}));else{if(!n._b_forward)return;window.pageReload()}}}),!1}function w(e,n){return a.confirm({title:r("Warning!"),type:a.TYPE_WARNING,message:r("Are you sure remove this accounting?"),callback:function(e){if(e)m.block(),c.call("ledger.deleteAccountingItem",n._id,(function(e){m.unblock(),n.paramsModal?m.trigger("partForward",n.paramsModal):window.pageReload(e)}));else{if(!n._b_forward)return;window.pageReload()}}}),!1}function g(e,n){return a.confirm({title:r("Warning!"),type:a.TYPE_WARNING,message:r("Are you sure, move back reservation forward?"),callback:function(e){if(!e)return window.pageReload();m.block(),c.call("forward.rmForward",{_id:n._id},(function(e){m.unblock(),window.pageReload(e)}))}}),!1}function y(r){var n=t.map(r.find("#add-fee-body .add-fee-item"),(function(r){var n=e(r),t={_s_type:n.find(".type").val(),desc:n.find(".desc").val(),_t_readonly:n.find(".desc").is("[readonly]")};return"percent"===t._s_type?t._f_percent=parseFloat(n.find(".percent").val()):"pernight"!==t._s_type&&"fixed"!==t._s_type||(t._mcval=n.find(".mcval")[0].get_mc()),t}));return r.find(".add-fee-ownbox").each((function(){var r=e(this),t={_s_type:r.data("type"),desc:r.data("desc"),_mcval:r.data("val"),_t_ownbox:1};"percent"===t._s_type&&(t._f_percent=r.data("percent")),n.unshift(t)})),n}f(["reserve.forward.edit"])&&(m.on("partForward",(function(r,a){var i=a._idforward,f=a._idreserve,p=a._b_forward;m.block(),n.run((function(r){c.call("ledger.doReserveInfo",i,f,!0,n.sure(r,(function(a){f||(f=a._idreserve),d.render("reservationForward/part-form",a,n.sure_result(r,(function(r){var v=e(r),b=v.find("#paynow");v.find("[data-toggle='popover']").popover({html:!0,container:v,placement:"auto"}),u(b,t.get(a.reserve,"_mcBalance.0",{})),l(v.find("input[name='expDate']"),Date.nowUTC()),v.modal("show"),v.on("hidden.bs.modal",(function(){v.remove(),p&&window.pageReload()})),v.on("click","#move-back",(function(){if(a.accounting.length)return!1;v.remove(),e(".modal-backdrop").remove(),m.trigger("rmForward",{_id:i})})),v.on("click","#go-pay",(function(){var r=b[0].get_mc(),d=t.keys(a.reserve._mcBalance[0])[0];if(!function(e){return!!parseFloat(e[t.keys(e)[0]])}(r))return;if(!d)throw new s("Invalid currency. Please contact with support team.");var u={_mcval:r,_idreserve_forward:i,_dt:v.find("[name='expDate']").val()?o.utc(v.find("[name='expDate']").data("datepicker").getUTCDate()).hours(12).toDate():o.utc(Date.nowUTC()).toDate(),_dtcreation:o.utc(Date.nowUTC()).toDate(),_t_createdType:"automatically",desc:a.reserve._dtcheckIn+" - "+a.reserve._dtcheckOut,_idapartment:a.reserve._idowner,type:"c"};v.block(),n.run((function(t){c.call("price.completeCurrencies",{_mcval:r,_i_round:2},n.sure(t,(function(r){var o=r[d],l=new _(a.reserve._mcBalance[0][d]).round(2).toNumber();return o<1?t(new s("Minimum amount is 1. But we received is %s %s.",s.Subject.INVALID_DATA,o,d)):o>l&&l>0?t(new s("Maximum amount is %s %s. But we received is %s %s.",s.Subject.INVALID_DATA,l,d,o,d)):void c.call("ledger.saveCreditLandlordEx",u,n.sure(t,(function(){c.call("ledger.updateStatusForward",i,n.sure_result(t,(function(){v.modal("hide"),p&&(v.remove(),e(".modal-backdrop").remove())})))})))})))}),(function(e){e?(v.unblock(),window.appError(e)):m.trigger("partForward",{_idforward:i,_idreserve:f,_b_forward:!0})}))})),v.on("click",".details-info",(function(r){v.modal("hide"),p&&(v.remove(),e(".modal-backdrop").remove());var t=e(r.target).closest("tr").data("_id");return n.run((function(r){c.call("ledger.getAccountings",{query:{_id:t}},n.sure(r,(function(t){var o=t.list[0];o.reload=p,o.ownerId=o._id,o.ownerCol="accounting",d.render("debit_account_dialog",{accounting:o},n.sure(r,(function(r){e(r).modal()})))})))}),window.appError),!1})),v.on("click",".add-accounting",(function(r){p?(v.remove(),e(".modal-backdrop").remove()):v.modal("hide");var o={};n.run((function(r){o._b_awaiting=1,c.call("translate.getTranslations","billResp",n.sure(r,(function(a){o._t_withPayButton=!0,a=Object.values(a),o._t_products_accounting=!0,a=t.filter(a,(function(e){return e.metadata._b_landlord||e.metadata._b_agency})),o.rel="reserve",o._idreserve_forward=i,d.render("finance/accounting_details",{accounting:o,billResp:a},n.sure_result(r,(function(r){e(r).modal()})))})))}),(function(e){window.appError(e),m.unblock()}))})),v.on("click",".remove-landlord-acc",(function(r){v.modal("hide"),p&&(v.remove(),e(".modal-backdrop").remove());var n=e(this).data("_id");m.trigger("rmLandlordAcc",{_id:n,_b_forward:p,paramsModal:{_idforward:i,_idreserve:f,_b_forward:1}})})),v.on("click",".remove-acc",(function(r){v.modal("hide"),p&&(v.remove(),e(".modal-backdrop").remove());var n=e(this).data("_id");m.trigger("rmAccounting",{_id:n,_b_forward:p,paramsModal:{_idforward:i,_idreserve:f,_b_forward:1}})}))})))})))}),(function(e){window.appError(e),m.unblock()}))})),m.on("confirm",(function(a,f){!function(a){if(!a.items[0]._idreserve)throw new s("There is no reserve id.");m.block(),a.add_fee=[],n.run((function(f){c.call("reserve.getReserves",{query:{_id:a.items[0]._idreserve},fields:{_idowner:1,_i_quantOfGuests:1,stats:1,price:1,add_fees:1,apartment_invoice:1,extras_invoice:1}},n.sure(f,(function(b){if(!b.count)return f(new s("Reserve with this name does not exist."));var w=b.list[0];c.call("fee.getApartmentFees",{_id:w._idowner,onlyActive:1,_b_chargeFromLandlord:1},n.sure(f,(function(b){a.deffCurr=w.stats.curr,t.forEach(b,(function(e){var r=w.apartment_invoice[e._id],n=w.extras_invoice[e._id];(!(w.price[e._id]||r||n)||r&&e._b_apartment_invoice||n&&e._b_extras_invoice)&&(e._b_mcval?(e._b_chargeByNights&&t.each(e._mcval,(function(r,n){e._mcval[n]=new _(r).times(w.price._i_totalDays).round(2).toNumber()})),e._b_chargeByPersons&&t.each(e._mcval,(function(r,n){e._mcval[n]=new _(r).times(w._i_quantOfGuests).times(w.price._i_totalDays).round(2).toNumber()})),a.add_fee.push({_s_type:"fixed",_msvalues:e._msvalues,desc:e.desc,_mcval:e._mcval})):(e._b_chargeByNights&&(e._f_percent=new _(e._f_percent).times(w.price._i_totalDays).round(2).toNumber()),e._b_chargeByPersons&&(e._f_percent=new _(e._f_percent).times(w._i_quantOfGuests).times(w.price._i_totalDays).round(2).toNumber()),a.add_fee.push({_s_type:"percent",_msvalues:e._msvalues,desc:e.desc,_f_percent:e._f_percent,_mcval:e._mcval})))})),function a(f,b,w){!function(e,o,a){if(o)return a(null,i);e.add_fee=e.add_fee||[];var d=t.map(e.items,"_idreserve"),u={forwardPrice:{cmd:"api",prm:["price.calcForwardPrice",{_idreserve:d[0],add_fee:e.add_fee,_mcbuyprice:e._mcbuyprice,_t_force:1}],res:{a:"store",v:"forwardPrice"}}},l=t.reduce(d,(function(e,r){return e[r]={cmd:"api",prm:["reserve.getReserveForCalendar",r],res:{a:"store",v:r}},e}),{});c.batch(l,"forward-reserves",n.sure(a,(function(o){var i=t.map(d,(function(n,a){var c=o[n];a||(c._t_active_tab=1),p=c;var i=t.get(c,"commission._mcval");if(!t.isEmpty(i)&&!e._b_recalculate){var d={};d="percent"===c.commissionType?{_s_type:"percent",_f_percent:c._f_comission,_mcval:i[c.stats.curr]?i:t.mergeWith({},c._mcval,(function(e,r){return new _(r||0).div(100).times(c._f_comission).round(2).toNumber()})),_t_ownbox:1,desc:t.get(c,"_t_partner.name",r("Partner fee"))}:{_s_type:"fixed",_mcval:i,_t_ownbox:1,desc:t.get(c,"_t_partner.name",r("Partner fee"))},e.add_fee.unshift(d)}return c}));c.batch(u,"forward-prices",n.sure(a,(function(r){var n=t(i).map("_idowner").uniq().compact().value();if(1!==n.length)return a(new s("Reserves must be related to one apartment."));e._idowner=n[0];var o={},c=i[0].stats.curr;if(o[c]=0,e._mcsellprice=t.get(r,"forwardPrice._mcsellprice",t.clone(o)),e._mcfee=t.get(r,"forwardPrice._mcfee",t.clone(o)),e._mcnetto=t.get(r,"forwardPrice._mcnetto",t.clone(o)),e._mcbuyprice=t.get(r,"forwardPrice._mcbuyprice",t.clone(o)),e._mccommission=t.get(r,"forwardPrice._mccommission",!1),e.commission=t.get(r,"forwardPrice.commission_model",{}),e._t_reserves=i,e.add_fee=t.get(r,"forwardPrice.add_fee",e.add_fee),v){var d=!1;t.each(e._mcbuyprice,(function(r,n){e._mccommission[n]=new _(e._mcnetto[n]).minus(r).round(2).toNumber(),e.commission._i_percent&&!d&&(d=!0,e.commission._i_percent=t.get(p,"_t_notShowOtaFees")?_(e._mccommission[n]).div(e._mcsellprice[n]).times(100).round(0).toNumber():_(e._mccommission[n]).div(e._mcnetto[n]).times(100).round(0).toNumber())}))}for(var u=0,l=Object.keys(e);u<l.length;u++){var f=l[u];f.startsWith("_mc")&&(e[f]=t.pick(e[f],c))}for(var m,b=_createForOfIteratorHelperLoose(e.add_fee);!(m=b()).done;){var w=m.value;w._mctotalFee=t.pick(w._mctotalFee,c)}a(null,e)})))})))}(f,b,n.sure(w,(function(r){i||(i=t.cloneDeep(r)),d.render("reservationForward/confirm-form",r,n.sure_result(w,(function(f){var p=e(f).validate();u(p.find("#buyprice"),r._mcbuyprice);var b=t.reduce(r.add_fee,(function(e,r){return r._t_ownbox&&(e+=1),e}),0);function w(){p.find("#save").prop("disabled",!0),p.find(".recalculate-form").toggleClass("hidden",!1)}function g(){p.find("#save").prop("disabled",!1),p.find(".recalculate-form").toggleClass("hidden",!0)}function h(){var e=p.find(".modal-body");n.run((function(t){a(r,!0,n.sure_spread(t,(function(r){e.replaceWith(r.find(".modal-body")),t()})))}),(function(r){window.appError(r),e.unblock()}))}function k(){p.find("#save").prop("disabled",!1);var e=p.find(".modal-body");(r=t.pick(r,["_dtcheckIn","_dtcheckOut","items","deffCurr"])).add_fee=y(p),r._b_recalculate=1,v&&(r._mcbuyprice=p.find("#buyprice")[0].get_mc()),e.block(),n.run((function(t){a(r,!1,n.sure_spread(t,(function(r){e.replaceWith(r.find(".modal-body")),t()})))}),(function(r){window.appError(r),e.unblock()}))}return t.each(r.add_fee,(function(r,n){var t=e(p.find("#add-fee-body .add-fee-item")[n-b]);u(t.find(".mcval"),r._mctotalFee||{})})),l(p.find("#checkin"),r._dtcheckIn,p.find("#checkout"),r._dtcheckOut),p.on("click","#add-fee",(function(){n.run((function(r){d.render("reservationForward/confirm-form-add-fee-item",{},n.sure(r,(function(r){var n=e(r);u(n.find(".mcval"),{}),u(n.find(".mcval-pn"),{}),p.find("#add-fee-body").append(n)})))}))})),p.on("click",".recalculate",h),p.on("change","#add-fee-body .type",(function(){var r=e(this).closest(".add-fee-item"),n=e(this).val();r.find(".percent").toggle("percent"===n),r.find(".mcval").toggle("pernight"===n||"fixed"===n),r.find(".show-total").toggle("percent"===n),"percent"===n?(r.find(".value").removeClass("col-sm-5"),r.find(".value").addClass("col-sm-3")):(r.find(".value").removeClass("col-sm-3"),r.find(".value").addClass("col-sm-5"));(parseFloat(r.find(".percent").val())||parseFloat(r.find(".curr").val()))&&k()})),p.on("change","#add-fee-body .curr",(function(r){p.find("#save").prop("disabled",!1),parseFloat(e(r.currentTarget).val())!==e(r.currentTarget).data("value")&&k()})),p.on("change","#add-fee-body .percent",k),p.on("change","#buyprice .curr",(function(n){if(p.find("#save").prop("disabled",!1),!n.isTrigger)return;var t=parseFloat(e(n.currentTarget).val()),o=parseFloat(e(n.currentTarget).data("value")),a=p.find("#buyprice .active-curr").text();if(new _(t).round(2).toNumber()==new _(o).round(2).toNumber())return;if(new _(t).round(2).toNumber()>new _(r._mcnetto[a]).round(2).toNumber())return window.appError(new s("Buy Price cannot exceed the value Corrected Sell Price"));v=1,k()})),p.on("focus","#add-fee-body .curr",w),p.on("focus","#add-fee-body .percent",w),p.on("focus","#buyprice .curr",w),p.on("blur","#add-fee-body .curr",g),p.on("blur","#add-fee-body .percent",g),p.on("blur","#buyprice .curr",g),p.on("click",".recalculate-form",g),p.on("click","#add-fee-ownbox-body .close",(function(){e(this).closest(".add-fee-ownbox").remove(),k()})),p.on("click","#add-fee-body .close",(function(){var r=e(this).closest(".add-fee-item");r.remove(),(parseFloat(r.find(".percent").val())||parseFloat(r.find(".curr").val()))&&k()})),p.on("hidden.bs.modal",(function(){i=null,v=null,p.remove()})),p.on("submit",(function(e){e.preventDefault();var a=t.keys(r._mcbuyprice)[0];if(r._mcbuyprice=p.find("#buyprice")[0].get_mc(),r._dtcheckIn=p.find("#checkin").data("datepicker").getUTCDate(),r._dtcheckOut=p.find("#checkout").data("datepicker").getUTCDate(),r.paid={_mcval:{},_mcmiss:{},_f_paid:0,_f_miss:100},r._dt=o.utc(Date.nowUTC()).toDate(),r.paid._mcval[a]=0,r.paid._mcmiss=r._mcbuyprice,r.add_fee=y(p),new _(r._mcbuyprice[a]).round(2).toNumber()>new _(r._mcnetto[a]).round(2).toNumber())return window.appError(new s("Buy Price cannot exceed the value Corrected Sell Price"));v&&new _(r._mcbuyprice[a]).round(2).toNumber()!==new _(i._mcbuyprice[a]).round(2).toNumber()&&(r._mcbuypriceOrg=i._mcbuyprice);p.block(),n.run((function(e){c.call("forward.editForward",r,n.sure(e,(function(t){c.call("forward.setForwardStatus",{_id:t},n.sure(e,(function(){i=null,v=null,p.modal("hide"),p.unblock(),m.trigger("partForward",{_idforward:t,_idreserve:r.items[0]._idreserve,_b_forward:!0})})))})))}),(function(e){p.unblock(),window.pageReload(e)}))})),[p,r]})))})))}(a,!1,n.sure_spread(f,(function(e){e.modal("show"),f()})))})))})))}),(function(e){window.appError(e),m.unblock()}))}(f)})),m.on("rmForward",g),m.on("rmLandlordAcc",b),m.on("rmAccounting",w),m.on("click",".partForward",(function(){var r=e(this).data("_idreserve_forward"),n=e(this).data("_id");m.trigger("partForward",{_idforward:r,_idreserve:n})})),m.on("click",'[name="reserve-info"]',(function(r){var n=e(r.target).closest("tr").data("_idreserve_forward"),t=e(r.target).closest("tr").data("_idreserve");m.trigger("partForward",{_idforward:n,_idreserve:t})})),m.on("click",".deleteBooking",(function(){var t=e(this).data("_id");a.confirm({title:r("Warning!"),type:a.TYPE_WARNING,message:r("Are you sure to exclude reservation?"),callback:function(e){e&&(m.block(),n.run((function(e){c.call("reserve.deleteReserveFromLandlordCalendar",t,e)}),(function(e){m.unblock(),window.pageReload(e)})))}})})),m.on("click",".confirm",(function(){var r=e(this),n=r.data("_id"),t={_dtcheckIn:r.data("_dtcheckin"),_dtcheckOut:r.data("_dtcheckout"),items:[{_idreserve:n}]};m.trigger("confirm",t)})),m.on("click",".rmForward",(function(r){g(r,{_id:e(this).data("_id")})})),m.on("click",".remove-landlord-acc",(function(r){b(r,{_id:e(this).data("_id")})})),m.on("click",".remove-acc",(function(r){w(r,{_id:e(this).data("_id")})})),m.on("click",".details-info-split-list",(function(r){var t,o;t={_id:e(r.target).closest("tr").data("_id")},o=t._id,n.run((function(r){c.call("ledger.getSplitInfo",{_id:o},n.sure(r,(function(o){d.render("split_account_dialog",{accounting:o},n.sure(r,(function(r){var n=e(r).modal();n.on("hidden.bs.modal",(function(){n.remove(),t._b_forward&&window.pageReload()}))})))})))}),window.appError)})))}))}}));