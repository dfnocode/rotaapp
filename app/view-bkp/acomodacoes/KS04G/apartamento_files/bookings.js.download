function _createForOfIteratorHelperLoose(e,r){var t;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(t=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(t=e[Symbol.iterator]()).next.bind(t)}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function asyncGeneratorStep(e,r,t,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,o)}function _asyncToGenerator(e){return function(){var r=this,t=arguments;return new Promise((function(n,o){var a=e.apply(r,t);function i(e){asyncGeneratorStep(a,n,o,i,s,"next",e)}function s(e){asyncGeneratorStep(a,n,o,i,s,"throw",e)}i(void 0)}))}}define(["jquery","safe","api","clitpl","lodash","i18n","request","checkperm","ApiError","bootstrap-dialog","views/reservation/booking_buttons","jquery-block"],(function(e,r,t,n,o,a,i,s,c,u,l){return function(d){var p=d.query;d.filter;return e((function(){l();var d=e("#maincontent");function f(){return b.apply(this,arguments)}function b(){return(b=_asyncToGenerator(regeneratorRuntime.mark((function r(){var n,o,a,s,u,l,p;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return d.block(),r.prev=1,n=e(this).attr("href"),r.next=5,i(n,{});case 5:o=r.sent,a=o._id,s=Date.now()+6e5;case 8:if(!(Date.now()<s)){r.next=24;break}return r.next=11,t.call("helpers.getExportData",{query:{_id:a},fields:{_id:1,error:1,filename:1,_b_end:1}});case 11:if(u=r.sent,l=u.list,!(p=l[0])||!p._b_end){r.next=20;break}if(!p.error){r.next=17;break}throw new c(p.error);case 17:return r.next=19,m(p._id,p.filename);case 19:return r.abrupt("break",24);case 20:return r.next=22,new Promise((function(e){return setTimeout(e,1e4)}));case 22:r.next=8;break;case 24:r.next=29;break;case 26:r.prev=26,r.t0=r.catch(1),window.appError(r.t0);case 29:return r.prev=29,d.unblock(),r.finish(29);case 32:case"end":return r.stop()}}),r,this,[[1,26,29,32]])})))).apply(this,arguments)}function m(e,r){return v.apply(this,arguments)}function v(){return(v=_asyncToGenerator(regeneratorRuntime.mark((function e(r,t){var n,o,a,i,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,window.fetch(window._prefix+"bookings-export/"+r);case 2:if(!(n=e.sent).ok){e.next=16;break}return e.next=6,n.blob();case 6:return o=e.sent,a=window.URL.createObjectURL(o),(i=document.createElement("a")).style.display="none",i.href=a,i.download=t,document.body.appendChild(i),i.click(),window.URL.revokeObjectURL(a),e.abrupt("return");case 16:throw(s=new Error(n.statusText)).statusCode=n.status,s;case 19:case"end":return e.stop()}}),e)})))).apply(this,arguments)}d.find(".btn-cc-view").popover(),d.find(".booking-item .booking-item-select").is(":checked")&&d.find(".btn-token-payment").removeClass("hidden"),d.on("click",".booking-item-select",(function(){d.find(".booking-item .booking-item-select").is(":checked")?d.find(".btn-token-payment").removeClass("hidden"):d.find(".btn-token-payment").addClass("hidden")})),d.on("click",".btn-token-payment",_asyncToGenerator(regeneratorRuntime.mark((function r(){var a,i,s,c,u,l,p,f,b,m,v,k,h;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:a=d.find(".booking-item .booking-item-select:checked").toArray().map((function(r){return e(r).val()})),i={reservesSelected:a.length,reservesHavePayments:0,reservesWithoutPayments:0},s=[],d.block(),r.prev=4,c=_createForOfIteratorHelperLoose(a);case 6:if((u=c()).done){r.next=15;break}return l=u.value,r.next=10,t.call("reserve.getReservation",l);case 10:p=r.sent,(f=p[0])&&s.push(f);case 13:r.next=6;break;case 15:for(b=0,m=s;b<m.length;b++)v=m[b],o.get(v,"paysinfo._i_totalpays",0)>=1?i.reservesHavePayments++:i.reservesWithoutPayments++;return r.next=18,n._render("reservation/booking_token_payment",{reserves:s,counts:i});case 18:k=r.sent,(h=e(k)).modal("show"),h.on("hidden.bs.modal",(function(){h.remove()})),r.next=27;break;case 24:r.prev=24,r.t0=r.catch(4),window.appError(r.t0);case 27:return r.prev=27,d.unblock(),r.finish(27);case 30:return r.abrupt("return",!1);case 31:case"end":return r.stop()}}),r,null,[[4,24,27,30]])})))),s(["reserve.delete"])&&d.on("click",".booking-delete",(function(){var t=e(this).closest(".booking-item"),o=e(this).data("_id"),a=e(this).data("bcomcode"),i=e(this).data("dcomcode");return t.block(),r.run((function(s){n.render("reservation/booking_item_delete_modal",{_id:o,bcomcode:a,dcomcode:i},r.sure_result(s,(function(r){var n=e(r).modal();n.on("done",(function(){n.modal("hide"),t.remove()}))})))}),(function(e){t.unblock(),window.appError(e)})),!1})),s(["reserve.card.view"])&&d.on("click",".markInvalid",(function(){var r=e(this).data("_id");u.confirm({title:a("Warning!"),type:u.TYPE_WARNING,message:a("Are you sure mark to invalid credit card? This action not possible to undone."),callback:function(n){n&&(e("#maincontent").block(),t.call("reserve.markToInvalidCCDATA",{_id:r},(function(r){e("#maincontent").unblock(),window.pageReload(r)})))}})})),d.find("#statistic").on("show.bs.collapse",_asyncToGenerator(regeneratorRuntime.mark((function r(){var o,a;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return d.block(),r.prev=1,r.next=4,t.call("reserve.getReservesStatistic",{query:p});case 4:return o=r.sent,r.next=7,n._render("reservation/statistic",{statistic:o});case 7:a=r.sent,e(this).append(a),e(this).off("show.bs.collapse"),r.next=15;break;case 12:r.prev=12,r.t0=r.catch(1),window.appError(r.t0);case 15:return r.prev=15,d.unblock(),r.finish(15);case 18:case"end":return r.stop()}}),r,this,[[1,12,15,18]])})))),d.find("#bookings-export").on("click",(function(){return f.call(this),!1}))}))}}));