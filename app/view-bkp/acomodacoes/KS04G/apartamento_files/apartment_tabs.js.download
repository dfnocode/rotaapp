function asyncGeneratorStep(e,t,n,a,r,i,o){try{var c=e[i](o),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(a,r)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(a,r){var i=e.apply(t,n);function o(e){asyncGeneratorStep(i,a,r,o,c,"next",e)}function c(e){asyncGeneratorStep(i,a,r,o,c,"throw",e)}o(void 0)}))}}define(["jquery","api","clitpl","lodash","bootstrap-dialog","autocomplete/apartac","checkperm","i18n","iziToast","admin/upload/photo"],(function(e,t,n,a,r,i,o,c,s){return function(d){var p=d.apartment,u=e("#maincontent");i(u.find("#apartment-select"),{queryFilter:{active:{$in:["yes","hidden"]},_id:{$ne:p._id},$or:a.map(p.types,(function(e){var t;return(t={})["types."+e]=1,t}))}}),u.find("#apartment-select").on("change",(function(){e(this).val()&&(window.open(window.location.pathname.replace("/"+p.id+"/","/"+e(this).find(":selected").data("id")+"/")+window.location.search),e(this).val("").change())})),u.find(".btn-content").on("click",_asyncToGenerator(regeneratorRuntime.mark((function a(){var r,i,o;return regeneratorRuntime.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return u.block(),a.prev=1,a.next=4,t.call("apartment.getListingContentScore",{_id:p._id});case 4:return r=a.sent,a.next=7,n._render("apartment/apartment_score",r);case 7:i=a.sent,(o=e(i).modal()).on("hidden.bs.modal",(function(){o.remove()})),a.next=15;break;case 12:a.prev=12,a.t0=a.catch(1),window.appError(a.t0);case 15:return a.prev=15,u.unblock(),a.finish(15);case 18:case"end":return a.stop()}}),a,null,[[1,12,15,18]])})))),o(["apartment.edit"])&&("draft"===p.active&&(e(".iziToast."+p.id).length||(s.info({icon:"",class:p.id,drag:!1,displayMode:1,timeout:window._autotest?3e3:null,close:!0,closeOnEscape:!0,maxWidth:"400px",message:"<p>"+c("Hi, Your listing is not active yet. Are you sure to keep it as draft? It will not be available to receive Reservations and other important actions at your Stays.net! Press this button to activate this listing.")+"</p><p><div class=\"btn btn-info\" id='apt-activate'>"+c("Activate")+"</div></p>"}),e(document).on("pageReload.end",(function(){window.location.href.includes("apartment/"+p.id)||e(".iziToast."+p.id).length&&s.hide({},e(".iziToast."+p.id)[0])})),e(".iziToast."+p.id+" #apt-activate").click(_asyncToGenerator(regeneratorRuntime.mark((function n(){return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.call("apartment.saveApartment",{_id:p._id,active:"hidden"});case 2:e(".iziToast."+p.id).length&&s.hide({},e(".iziToast."+p.id)[0]),window.pageReload();case 4:case"end":return n.stop()}}),n)})))))),u.find("#accordion #apt-status").on("click","li > a",_asyncToGenerator(regeneratorRuntime.mark((function n(){return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return u.block(),n.prev=1,n.next=4,t.call("apartment.saveApartment",{_id:p._id,active:e(this).attr("href").replace("#","")});case 4:e(".iziToast."+p.id).length&&s.hide({},e(".iziToast."+p.id)[0]),window.pageReload(),n.next=11;break;case 8:n.prev=8,n.t0=n.catch(1),window.appError(n.t0);case 11:return n.prev=11,u.unblock(),n.finish(11);case 14:case"end":return n.stop()}}),n,this,[[1,8,11,14]])})))),u.on("click","#btn-select-image",function(){var i=_asyncToGenerator(regeneratorRuntime.mark((function i(o){var s,d,l,m,h,v,f,g;return regeneratorRuntime.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(g=function(){return(g=_asyncToGenerator(regeneratorRuntime.mark((function e(n,r){var i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i={_id:p._id,_idavatar:n},r&&(i.images=p.images||[],a.find(i.images,{_id:n})||(i.images.push({_id:n}),p.images=i.images)),e.prev=2,s.$modal.block(),e.next=6,t.call("apartment.saveApartment",i);case 6:u.find("#main-avatar").css("background-image","url(/image/"+n+"?width=372)"),s.close(),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(2),window.appError(e.t0);case 13:return e.prev=13,s.$modal.unblock(),e.finish(13);case 16:case"end":return e.stop()}}),e,null,[[2,10,13,16]])})))).apply(this,arguments)},f=function(e,t){return g.apply(this,arguments)},o.preventDefault(),e(this).button("loading"),i.prev=4,u.block(),!p._id){i.next=13;break}return i.t0=Object,i.t1=p,i.next=11,t.call("apartment.getSimpleOneApartment",{_id:p._id},{_idavatar:1,images:1,_idbuilding:1});case 11:i.t2=i.sent,p=i.t0.assign.call(i.t0,i.t1,i.t2);case 13:if(d=a.map(p._t_images,"_id"),p._idavatar&&!d.includes(p._idavatar)&&d.unshift(p._idavatar),!d.length){i.next=24;break}return i.next=18,n._render("apartment/apartment_photo_select",{images:a.uniq(d)});case 18:l=i.sent,m=e(l),s=r.show({title:c("Click at picture you want to set as Listing Main Photo"),type:r.TYPE_DEFAULT,size:r.SIZE_WIDE,message:m}),m.find("[data-_id]").popover({html:!0,delay:400,trigger:"hover"}).click((function(t){t.preventDefault();var n=e(this).data("_id");return f(n),!1})),i.next=30;break;case 24:return i.next=26,n._render("apartment/apartment_photo_upload",{apartment:p});case 26:h=i.sent,v=e(h),s=r.show({title:c("Upload Listing Main Photo"),type:r.TYPE_DEFAULT,message:v}),v.photoUploader((function(e){var t=e[0];f(t,!0)}));case 30:i.next=35;break;case 32:i.prev=32,i.t3=i.catch(4),window.appError(i.t3);case 35:return i.prev=35,u.unblock(),e(this).button("reset"),i.finish(35);case 39:case"end":return i.stop()}}),i,this,[[4,32,35,39]])})));return function(e){return i.apply(this,arguments)}}()))}}));