function asyncGeneratorStep(e,n,t,r,i,a,o){try{var c=e[a](o),s=c.value}catch(e){return void t(e)}c.done?n(s):Promise.resolve(s).then(r,i)}function _asyncToGenerator(e){return function(){var n=this,t=arguments;return new Promise((function(r,i){var a=e.apply(n,t);function o(e){asyncGeneratorStep(a,r,i,o,c,"next",e)}function c(e){asyncGeneratorStep(a,r,i,o,c,"throw",e)}o(void 0)}))}}define(["jquery","safe","lodash","moment","PricePicker","api","clitpl","jquery-block","bootstrap"],(function(e,n,t,r,i,a,o){return function(c){var s=c.filter,l=c.crossselling;return e((function(){"use strict";var c={commissionType:"percent"},d=e("#tabboard").parent();function f(){n.run((function(e){d.find("#apartment").block(),o.render("reservation/booking_apartment",{selected_apt:c._t_apartment,editable:c._id?0:1,filter:s,page:0,crossselling:l},n.sure_result(e,(function(e,n){d.find("#apartment").html(e)})))}),(function(e){window.appError(e),d.find("#apartment").unblock()}))}d.find("li:first a").tab("show"),f(),d.find("a").click((function(n){return e(this).closest("li").hasClass("disabled")||e(this).tab("show"),!1})),d.find('a[href=".apartment"]').on("shown.bs.tab",f),d.find('a[href=".client"]').on("shown.bs.tab",(function(){n.run((function(e){d.find("#client").block(),o.render("reservation/booking_client",{selected_client:c._t_client,editable:c._id?0:1},n.sure_result(e,(function(e,n){d.find("#client").html(e)})))}),(function(e){window.appError(e),d.find("#client").unblock()}))})),d.find('a[href=".relation"]').on("shown.bs.tab",(function(){n.run((function(r){d.find("#relation").block();var i={reserv:c,_t_hasPriceError:c._t_hasPriceError};t.get(c,"_t_apartment.idchannel")&&(i.extApartment=c._t_apartment,i.extApartment._mcstaysCommisson=c.price._mcstaysCommisson),o.render("reservation/booking_relation",i,n.sure_result(r,(function(n){var t=e(n);d.find("#relation").unblock(),d.find("#relation").html(t)})))}),(function(e){d.find("#relation").unblock(),window.appError(e)}))})),d.find(".prev-step").click((function(){var e=d.find("li.active").prev();e&&e.find("a").tab("show")})),d.find(".next-step").click((function(){var e=d.find("li.active").next();e&&e.find("a").tab("show")})),d.find("#apartment").on("ApartmentSelected",(function(e,n,i,a){return c._t_apartment=n,c._idowner=n._id,c._mcdepos=n._mcdeposit,c.price=i,c._mcval=t.clone(i._mctotal),c._dtcheckIn=r.utc(i._dtstart).startOf("day").hours(n.arrival._i_defCheckIn).toDate(),c._dtcheckOut=r.utc(i._dtend).startOf("day").hours(n.departure._i_defCheckOut).toDate(),i._i_persons&&(c._i_quantOfGuests=i._i_persons,c._i_adults=i._i_persons,c._i_children=0),c.type="reserved",a&&(c._t_hasPriceError=!0),d.find('a[href=".client"]').tab("show"),d.find('a[href=".client"]').closest("li").removeClass("disabled"),d.find(".apartment.tab-pane .next-step").prop("disabled",!1),!1})),d.find("#client").on("ClientSelected",(function(e,n){return c._t_client=n,c._idclient=n._id,d.find('a[href=".relation"]').tab("show"),d.find('a[href=".relation"]').closest("li").removeClass("disabled"),d.find(".client.tab-pane .next-step").prop("disabled",!1),!1})),d.on("make-booking",function(){var e=_asyncToGenerator(regeneratorRuntime.mark((function e(n,r){var o,l,f,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((c=t.merge(c,r))._mcval=t.pick(c._mcval,c._t_curr),c._mcdepos=t.pick(c._mcdepos,c._t_curr),c.price=i.pick(c.price,c._t_curr),o=t.cloneDeep(c),l=c._t_apartment,delete o._t_apartment,delete o._t_client,c.price._mcstaysCommisson&&(o.idchannel=l.idchannel,o.isMaster=1),e.prev=9,d.block(),!s.transform){e.next=18;break}return e.next=14,a.call("reserve.transformReservation",s.transform,o);case 14:f=e.sent,window.pageReload(null,window._prefix+"reservation/"+f),e.next=22;break;case 18:return e.next=20,a.call("adminapi.saveAdminReservation",o);case 20:u=e.sent,window.pageReload(null,window._prefix+"reservation/"+u);case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(9),window.appError(e.t0);case 27:return e.prev=27,d.unblock(),e.finish(27);case 30:case"end":return e.stop()}}),e,null,[[9,24,27,30]])})));return function(n,t){return e.apply(this,arguments)}}())}))}}));